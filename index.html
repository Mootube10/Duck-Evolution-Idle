<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Duck Evolution Idle</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121931; --muted:#93a1bd; --text:#e9efff; --accent:#7cc5ff; --good:#7fff9f; --warn:#ffd27c; --bad:#ff8a8a;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,sans-serif;background:radial-gradient(1200px 800px at 20% -10%,#19234a 0%,#0b1020 45%), var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center}
    .title{font-size:28px;font-weight:800;letter-spacing:.3px}
    .stats{display:grid;grid-auto-flow:column;gap:16px;background:rgba(255,255,255,.04);padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.06)}
    .chip{display:flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)}
    .chip b{font-variant-numeric:tabular-nums}

    main{display:grid;grid-template-columns:1.1fr .9fr;gap:20px;margin-top:18px}
    @media (max-width: 900px){main{grid-template-columns:1fr;}}

    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .card h2{margin:0 0 12px 0;font-size:18px;color:#cfe2ff;letter-spacing:.2px}
    .card .body{padding:16px}

    .big-action{display:grid;place-items:center;aspect-ratio:1.8/1;background:linear-gradient(135deg,#1a2752,#0f1839);border-bottom:1px solid rgba(255,255,255,.08);border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)}
    .big-btn{font-size:24px;font-weight:800;padding:18px 28px;border-radius:16px;border:0;cursor:pointer;background:linear-gradient(180deg,#a7e3ff,#7cc5ff);color:#00223d;box-shadow:0 10px 30px rgba(124,197,255,.35);transition:transform .05s}
    .big-btn:active{transform:translateY(1px)}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width: 640px){.grid{grid-template-columns:1fr}}
    .btn{width:100%;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn .small{font-weight:600;opacity:.8;font-size:12px}

    .dex{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .duck{padding:12px;border-radius:16px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08)}
    .duck .name{font-weight:800}
    .rarity{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);opacity:.9}
    .r-Common{background:rgba(124,255,255,.06)}
    .r-Rare{background:rgba(127,255,159,.08)}
    .r-Legendary{background:rgba(255,210,124,.08)}

    #wildDuck{display:none;position:fixed;bottom:20px;right:20px;font-size:40px;cursor:pointer;z-index:2000}

    footer{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12px}
    a.link{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">ü¶Ü Duck Evolution Idle</div>
      <div class="stats">
        <div class="chip">ü•ö Eggs: <b id="eggs">0</b></div>
        <div class="chip">ü¶Ü Ducks: <b id="ducks">0</b></div>
        <div class="chip">‚ö° EPS: <b id="eps">0</b></div>
        <div class="chip">üí† Feathers: <b id="feathers">0</b></div>
        <div class="chip">üè° Habitat: <b id="habitat">Pond</b></div>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="big-action">
          <button id="layBtn" class="big-btn">Click to Lay Egg (+1)</button>
        </div>
        <div class="body">
          <h2>Actions</h2>
          <div class="grid">
            <button id="hatchBtn" class="btn">
              Hatch Duck ‚Äî <span id="hatchCost">10</span>ü•ö
              <div class="small">Converts eggs into a new duck</div>
            </button>
            <button id="evolveBtn" class="btn">
              Evolve Duck ‚Äî <span id="evolveCost">100</span>ü•ö
              <div class="small">Try to mutate a common into something rarer</div>
            </button>
            <button id="feederBtn" class="btn">
              Buy Feeder ‚Äî <span id="feederCost">50</span>ü•ö
              <div class="small">+0.5 passive EPS (scales 25% each)</div>
            </button>
            <button id="habitatBtn" class="btn">
              Upgrade Habitat ‚Äî <span id="habitatCost">200</span>ü•ö
              <div class="small">Boost EPS with new environment</div>
            </button>
            <button id="prestigeBtn" class="btn">
              Prestige (Rebirth)
              <div class="small">Reset for Golden Feathers (boost EPS)</div>
            </button>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="body">
          <h2>Duckdex</h2>
          <div id="dex" class="dex"></div>
        </div>
      </section>

      <section class="card">
        <div class="body">
          <h2>Achievements</h2>
          <div id="achievements"></div>
        </div>
      </section>

      <section class="card">
        <div class="body">
          <h2>Prestige Perks</h2>
          <div id="perks"></div>
        </div>
      </section>
    </main>

    <footer>
      <span>Autosaves locally. üíæ</span>
      <button id="saveBtn" class="btn" style="width:auto;padding:6px 10px">Save</button>
      <button id="resetBtn" class="btn" style="width:auto;padding:6px 10px;background:rgba(255,0,0,.12);border-color:rgba(255,0,0,.25)">Hard Reset</button>
      <span style="margin-left:auto">v0.2 ‚Äî by You</span>
    </footer>
  </div>

  <div id="wildDuck">ü¶Ü</div>

  <script>
    // === Game Additions ===
    const habitats = ['Pond','Lake','Fountain','Space Station'];
    const achievementsList = [
      {id:1, text:'First Duck Hatched', condition:(s)=>s.totalHatched>=1},
      {id:2, text:'100 Eggs Collected', condition:(s)=>s.eggs>=100},
      {id:3, text:'Prestige Once', condition:(s)=>s.feathers>=1},
    ];
    const perksList = [
      {id:'cheapHatch', name:'Cheaper Hatching', cost:1, effect:(s)=>s.hatchDiscount=true},
      {id:'fastClick', name:'Faster Clicking', cost:2, effect:(s)=>s.clickPower=2},
      {id:'rareBoost', name:'Rare Chance Boost', cost:3, effect:(s)=>s.rareBoost=true},
    ];

    // Extend default state
    const oldDefault = defaultState;
    defaultState = ()=>(Object.assign(oldDefault(), {
      achievements:[],
      habitat:0,
      perks:[],
      clickPower:1,
      hatchDiscount:false,
      rareBoost:false
    }));

    // Extend save/load
    const oldLoad = load;
    load = ()=> {
      let s = oldLoad();
      return Object.assign(defaultState(), s);
    };

    // Upgrade Habitat
    function habitatCost(){return Math.floor(200*Math.pow(2,state.habitat));}
    function upgradeHabitat(){
      const cost = habitatCost();
      if(state.eggs<cost) return flash('Not enough eggs','warn');
      if(state.habitat>=habitats.length-1) return flash('Max habitat reached','warn');
      state.eggs-=cost;
      state.habitat++;
      flash('Habitat upgraded ‚ûú '+habitats[state.habitat]);
      renderStats();
    }

    // Achievements
    function checkAchievements(){
      achievementsList.forEach(a=>{
        if(!state.achievements.includes(a.id) && a.condition(state)){
          state.achievements.push(a.id);
          flash('Achievement Unlocked: '+a.text,'good');
        }
      });
    }

    // Perks
    function buyPerk(id){
      const perk = perksList.find(p=>p.id===id);
      if(!perk) return;
      if(state.feathers>=perk.cost && !state.perks.includes(id)){
        state.feathers-=perk.cost;
        state.perks.push(id);
        perk.effect(state);
        flash('Bought perk: '+perk.name,'good');
        renderPerks();
      }
    }

    // Offline Progress
    (function offline(){
      const now=Date.now();
      const diff=Math.floor((now-state.lastTick)/1000);
      if(diff>5){
        state.eggs+=currentEPS()*diff;
        flash('While you were away, your ducks produced '+fmt(currentEPS()*diff)+' eggs!','good');
      }
    })();

    // Wild Duck random event
    setInterval(()=>{
      if(Math.random()<0.01){
        const wild=el('wildDuck');
        wild.style.display='block';
        setTimeout(()=>wild.style.display='none',3000);
      }
    },5000);
    el('wildDuck').addEventListener('click',()=>{
      state.eggs+=50;
      flash('You caught a Wild Duck! +50 eggs','good');
      el('wildDuck').style.display='none';
      renderStats();
    });

    // Extend functions
    const oldHatchCost = hatchCost;
    hatchCost = ()=> state.hatchDiscount ? 5 : oldHatchCost();
    const oldLay = ()=>{state.eggs+=1;};
    el('layBtn').onclick = ()=>{state.eggs+=state.clickPower;renderStats();};

    const oldRenderStats = renderStats;
    renderStats = ()=>{oldRenderStats();el('habitat').textContent=habitats[state.habitat];el('habitatCost').textContent=fmt(habitatCost());};

    function renderAchievements(){
      const box = el('achievements');
      box.innerHTML = achievementsList.map(a=>`<div>${state.achievements.includes(a.id)?'üèÜ':''} ${a.text}</div>`).join('');
    }
    function renderPerks(){
      const box = el('perks');
      box.innerHTML = perksList.map(p=>`<div>${p.name} (Cost: ${p.cost}) ${state.perks.includes(p.id)?'‚úÖ':`<button onclick=\"buyPerk('${p.id}')\">Buy</button>`}</div>`).join('');
    }

    // Hook actions
    el('habitatBtn').addEventListener('click', upgradeHabitat);
    const oldHatch = hatchDuck;
    hatchDuck = ()=>{const id=oldHatch();if(id)checkAchievements();return id;};
    const oldEvolve = evolveDuck;
    evolveDuck = (...args)=>{const res=oldEvolve(...args);checkAchievements();return res;};

    // Extend prestige
    const oldPrestige = doPrestige;
    doPrestige = ()=>{const perks=state.perks;const worked=oldPrestige();state.perks=perks;perks.forEach(p=>perksList.find(x=>x.id===p).effect(state));renderPerks();return worked;};

    // Extend renderDex
    const oldRenderDex = renderDex;
    renderDex = ()=>{oldRenderDex();SPECIES.forEach(s=>{const div=[...dex.querySelectorAll('.duck')].find(d=>d.querySelector('.name').textContent.includes(s.name));if(div){div.innerHTML+=`<div style=\"margin-top:6px;opacity:.7;font-size:12px\">${s.desc}</div>`;}});};

    // Initial render updates
    renderAchievements();
    renderPerks();
  </script>
</body>
</html>

